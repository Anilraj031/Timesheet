{% extends "base.html" %}
{% block title %}Ticket List{% endblock %}
{% block script %}

<link href="/static/css/drag-n-drop.css" rel="stylesheet" />
<style>
</style>
<script>
    $(document).ready(function(){
        //$("#tableView").hide();
        //$("#cardView").hide();
    });
    
</script>
{% endblock %}
{% block content %}
<div class="container">
    <div class="table-wrapper">
        <div class="table-title">
            <div class="row d-flex justify-content-between">
                <div class="col-sm-4 col-md-6 col-xs-8 col-12 text-secondary">
                    <h2><b>Manage Tickets</b></h2>
                </div><!---->
                <div class="col-sm-3 col-12"> 
                    <select id="sview" class="form-control form-control-sm">
                        <option value="assignedcard">Assigned To Me</option>
                        <option value="card">View All</option>
                        <option value="table">All Table List</option>
                    </select>
                    <!--
                    <a class="btn btn-success btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#ticketModal"><i class="fas fa-solid fa-plus"></i><span>Add New Ticket</span></a>
                    -->
                </div>  
            </div>
        </div><hr>

        <div id="myAssignedView" class="mt-2 mb-3">
            <div class="row">
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="new" ondrop="drop(event)" ondragover="allowDrop(event)" style="height:500px;">
                    <div class="d-flex justify-content-between" style="border-bottom: 4px solid blue !important;">
                        <div ><h5 class="text-primary">New</h5></div>
                        <div ><a href="#" data-bs-toggle="modal" data-bs-target="#ticketModal"><span>Add Ticket</span></a></div>
                    </div>
                    {%for i in mytickets %}
                    {% if i.state == 'New' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card  mb-3 rounded-1 mt-2" style="border-left: 0.25rem solid {% if i.priority == 'high' %} #e74a3b {% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="inprogress" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between" style="border-bottom: 4px solid cyan !important;">
                        <div ><h5 class="text-info">In Progress</h5></div>
                    </div>
                    {%for i in mytickets %}
                    {% if i.state == 'InProgress' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card mt-2  mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="hold" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between" style="border-bottom: 4px solid brown !important;">
                        <div ><h5 class="text-secondary">On Hold</h5></div>
                    </div>
                    {%for i in mytickets %}
                    {% if i.state == 'Hold' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card mt-2 mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="complete" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between" style="border-bottom: 4px solid seagreen !important;">
                        <div ><h5 class="text-success">Completed</h5></div>
                    </div>
                    {%for i in mytickets %}
                    {% if i.state == 'Completed' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card mt-2 mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="canceled" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between" style="border-bottom: 4px solid darkred !important;">
                        <div ><h5 class="text-danger">Canceled</h5></div>
                    </div>
                    {%for i in mytickets %}
                    {% if i.state == 'Canceled' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card mt-2 mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="cardView" class="mt-2 mb-3" style="display:none;">
            <div class="row">
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="new" ondrop="drop(event)" ondragover="allowDrop(event)" >
                    <div class="d-flex justify-content-between">
                        <div ><h5 class="text-primary">New</h5></div>
                        <div ><a href="#" data-bs-toggle="modal" data-bs-target="#ticketModal"><span>Add Ticket</span></a></div>
                    </div>
                    {%for i in ticket%}
                    {% if i.state == 'New' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card  mb-3 rounded-1" style="border-left: 0.25rem solid {% if i.priority == 'high' %} #e74a3b {% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="inprogress" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between">
                        <div ><h5 class="text-info">In Progress</h5></div>
                    </div>
                    {%for i in ticket%}
                    {% if i.state == 'InProgress' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card  mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="hold" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between">
                        <div ><h5 class="text-secondary">On Hold</h5></div>
                    </div>
                    {%for i in ticket%}
                    {% if i.state == 'Hold' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card  mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="complete" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between">
                        <div ><h5 class="text-success">Completed</h5></div>
                    </div>
                    {%for i in ticket%}
                    {% if i.state == 'Completed' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card  mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="column column-todo col-12 col-md-3 col-sm-6" id="canceled" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="d-flex justify-content-between">
                        <div ><h5 class="text-danger">Canceled</h5></div>
                    </div>
                    {%for i in ticket%}
                    {% if i.state == 'Canceled' %}
                    <div draggable="true" ondragstart="drag(event)" data-id="{{i.id}}" class="card  mb-3 rounded-1" style="border-left: 0.25rem solid{% if i.priority == 'high' %}#e74a3b{% elif i.priority == 'medium' %}#36b9cc{% elif i.priority == 'low' %}#4e73df {% endif %};">
                        <div class="card-body text-primary">
                        <h6 class="card-title">{{i.ticket_name}}</h6>
                        <span class="fw-light">{{i.ticket_type}}</span>
                        <p class="card-text text-secondary mt-0"> {{i.short_desc}}</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div ><span class="ms-2 text-secondary">{{i.assigned_to}}</span></div>
                            <div ><span class="me-2"><a href="{% url 'issueDetails' issueid=i.id %}">view details</a></span></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="tableView" class="mt-2 mb-3 table-responsive" style="display:none;">
            <table class="table table-striped table-hover text-medium-emphasis "  id="ticketTable">
                <thead style="background-color:cornflowerblue;" >
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Created</th>
                        <th>Customer</th>
                        <th>Priority</th>
                        <th>State</th>
                        <th>Assigned To</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {%for i in ticket%}
                    <tr>
                        <td>{{i.ticket_name}}</td>
                        <td>{{i.ticket_type}}</td>
                        <td>{{i.open_date}}</td>
                        <td><a href="{% url 'customerDetails' id=i.affected_user.company.id %}">{{i.affected_user.email}}</a></td>
                        <td><span class="badge rounded-0 {% if i.priority == 'high' %}text-bg-danger{% elif i.priority == 'medium' %}text-bg-info{% elif i.priority == 'low' %}text-bg-primary{% endif %}">{{i.priority}}</span></td>
                        <td>
                            <span class="badge rounded-0 {% if i.state == 'New' %}text-bg-primary{% elif i.state == 'InProgress' %}text-bg-info{% elif i.state == 'Completed' %}text-bg-success{% elif i.state == 'Hold' %}text-bg-warning{% elif i.state == 'Canceled' %}text-bg-danger{% endif %}">{{i.state}}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center"><img class="rounded-circle" src="https://i.imgur.com/C4egmYM.jpg" width="30"><span class="ms-2">{{i.assigned_to}}</span></div>
                        </td>
                        <td>
                            <a href="{% url 'issueDetails' issueid=i.id %}" class="btn btn-info btn-sm bg-transparent p-1 border-0 pb-0"><i class="fas fa-solid fa-pen text-primary"></i></a>
                            <a  class="btn btn-info btn-sm bg-transparent p-1 border-0 pb-0" data-bs-toggle="modal" data-bs-target="#deleteModal" data-bs-whatever="{{i.id}}" onclick="setForm({{i.id}},'{{i.ticket_name}}')"><i class="fas fa-sharp fa-solid fa-trash text-danger"></i></a>
                        </td>
                    </tr>
                    {%endfor%}
                </tbody>
            </table>
        </div>
        
        
    </div>
</div>

<!-- Add Modal HTML -->
<div class="modal fade" id="ticketModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content rounded-0 container">
            <form action="{%url 'add' %}" method= "POST">
                {%csrf_token%}
                <div class="modal-header">                      
                    <h4 class="modal-title">Add Ticket</h4>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-secondary">                    
                    <div class="form-group row">
                        <div class="col-6  p-3">
                            <div class="col-md-12 col-sm-12">
                                <label>Title</label>
                                <input name= "ticketName" type="text" class="form-control form-control-sm rounded-0" required>
                            </div>
                            <div class="col-sm-12 mt-2">
                                <label>Ticket Type</label>
                                <select id="tickettype" name="ticketType"  class="form-control form-control-sm rounded-0">
                                <option value="Incident">Incident</option>
                                <option value="Operational Change">Operational Change</option>
                                <option value="Standard Enhancement">Standard Enhancement</option>
                                <option value="Normal Enhancement">Normal Enhancement</option>
                                </select>
                            </div>
                            <div class="form-group mt-2">
                                <label>Short Description </label>
                                <textarea rows='4' name = "shortDesc" type="text" class="form-control rounded-0" required></textarea>
                            </div>
                        </div>
                        <div class="col-6   p-3">
                            <div class="col-md-12 col-sm-12">
                                <label>Customer</label>
                                <select  name="affUser"  class="form-control form-control-sm rounded-0">
                                    <option value='0'>Customer</option>
                                    {% for u in customer %}
                                    <option value='{{u.id}}'>{{u.email}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6 col-sm-12 mt-2">
                                <label>Date opened</label>
                                <input  name = "dateOpened" type="date"  class="form-control form-control-sm rounded-0" required>
                            </div>
                            <div class="col-md-6 col-sm-12 mt-2">
                                <label>Priority</label>
                                <select id="priority" name="priority"  class="form-control form-control-sm rounded-0">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-sm-12 mt-3">
                                <label>Assigned to </label>
                                <select  name="assTo"  class="form-control form-control-sm rounded-0">
                                    <option value='0'>Select User</option>
                                    {% for u in users %}
                                        <option value='{{u.id}}'>{{u.username}}</option>
                                    {% endfor %}
                                </select>
                                <input hidden id="statelist" name="state" value="New" class="form-control form-control-sm rounded-0" />
                            </div>
                        </div>
                    </div>
                    <!--
                    <div class="form-group row mt-2">
                        
                        <div class="col-md-4 col-sm-12">
                            <label>State</label>
                            <select id="statelist" name="state" class="form-control form-control-sm rounded-0">
                                <option value="New">New</option>
                                <option value="InProgress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Hold">Hold</option>
                                <option value="Canceled">Canceled</option>
                            </select>
                        </div>
                    </div>
                    -->
                    <div class="form-group mt-2">
                        <label>Comments</label>
                        <textarea  name = "comments" class="form-control rounded-0" ></textarea>
                    </div>
            
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
                    <input type="submit" class="btn btn-success btn-sm" value="Add">
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mark as done Modal HTML -->
<div id="doneTicketModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <form>
                <div class="modal-header">                      
                    <h4 class="modal-title">Mark as done</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <div class="modal-body">                    
                    <p>Are you sure you want to mark these tickets as done?</p>
                    
                </div>
                <div class="modal-footer">
                    <input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
                    <input type="submit" class="btn btn-danger" value="done">
                </div>
            </form>
        </div>
    </div>
</div>
<!--delete modal-->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content rounded-0">
                <div class="modal-header">                      
                    <h4 class="modal-title">Delete Ticket</h4>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">                    
                    <p>Are you sure you want to delete ticket <span id="tname" class="fw-bold"><span></p>
                    <p class="text-danger"><small>Please make sure you want to delete this record. This action cannot be undone.</small></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
                    <a href="#" id="delF" type="submit" class="btn btn-danger btn-sm" value="Delete">Delete</a>
                </div>
        </div>  
    </div>
</div>



<script>
    $(document).ready(function () {
		$('#ticketTable').dataTable({
		  pagingType: 'full_numbers',
		  lengthChange: false,
          dom: 'Bfrtip',
          buttons: [
            {
                text: 'Open Ticket',
                className: 'btn btn-success btn-sm float-start',
                action: function ( e, dt, node, config ) {
                    //alert( 'Button activated' );
                    $("#ticketModal").modal('show');
                }
            }],
	  });
	});

    function setForm(id,name){
        //alert(name);
        $("#tname").text(name);
        document.getElementById("delF").href = "/Issue/delete/"+id;
    
    }

    $("#sview").change(function() {
        val1=$("#sview").val()
        if(val1 == 'card'){
            $("#cardView").show();
            $("#tableView").hide();
            $("#myAssignedView").hide();
        }
        else if(val1 == 'assignedcard')
        {
            $("#myAssignedView").show();
            $("#cardView").hide();
            $("#tableView").hide();
        }
        else{
            $("#myAssignedView").hide();
            $("#cardView").hide();
            $("#tableView").show();
        }
        
    });


    //for drag and Description
    function updateStatus(stat,id)
    {
        //alert("Status:"+stat+" $ id:"+id);
        data={status:stat,id}
        $.ajax({
            url: "{% url 'updateTicketStatus' %}",
            method: "POST",
            data: data,
            success: function(data){
                    //alert(data.result);
            },
        });
    }
</script>
<script src="/static/js/drag-n-drop.js"></script>
{% endblock %}